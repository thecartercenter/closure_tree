<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Closure tree by mceachen</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>Closure tree</h1>
        <p>Easily and efficiently make your ActiveRecord model support hierarchies</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/mceachen/closure_tree" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/mceachen/closure_tree/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/mceachen/closure_tree/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h1>
<a id="closure-tree" class="anchor" href="#closure-tree" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Closure Tree</h1>

<h3>
<a id="closure_tree-lets-your-activerecord-models-act-as-nodes-in-a-tree-data-structure" class="anchor" href="#closure_tree-lets-your-activerecord-models-act-as-nodes-in-a-tree-data-structure" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Closure_tree lets your ActiveRecord models act as nodes in a <a href="http://en.wikipedia.org/wiki/Tree_%28data_structure%29">tree data structure</a>
</h3>

<p>Common applications include modeling hierarchical data, like tags, threaded comments, page graphs in CMSes,
and tracking user referrals.</p>

<p><a href="http://travis-ci.org/mceachen/closure_tree"><img src="https://secure.travis-ci.org/mceachen/closure_tree.png?branch=master" alt="Build Status"></a>
<a href="http://rubygems.org/gems/closure_tree"><img src="https://badge.fury.io/rb/closure_tree.png" alt="Gem Version"></a>
<a href="https://codeclimate.com/github/mceachen/closure_tree"><img src="https://codeclimate.com/github/mceachen/closure_tree.png" alt="Code Climate"></a>
<a href="https://gemnasium.com/mceachen/closure_tree"><img src="https://gemnasium.com/mceachen/closure_tree.png" alt="Dependency Status"></a></p>

<p>Dramatically more performant than
<a href="https://github.com/stefankroes/ancestry">ancestry</a> and
<a href="https://github.com/amerine/acts_as_tree">acts_as_tree</a>, and even more
awesome than <a href="https://github.com/collectiveidea/awesome_nested_set/">awesome_nested_set</a>,
closure_tree has some great features:</p>

<ul>
<li>
<strong>Best-in-class select performance</strong>:

<ul>
<li>Fetch your whole ancestor lineage in 1 SELECT.</li>
<li>Grab all your descendants in 1 SELECT.</li>
<li>Get all your siblings in 1 SELECT.</li>
<li>Fetch all <a href="#nested-hashes">descendants as a nested hash</a> in 1 SELECT.</li>
<li>
<a href="#find_or_create_by_path">Find a node by ancestry path</a> in 1 SELECT.</li>
</ul>
</li>
<li>
<strong>Best-in-class mutation performance</strong>:

<ul>
<li>2 SQL INSERTs on node creation</li>
<li>3 SQL INSERT/UPDATEs on node reparenting</li>
</ul>
</li>
<li>
<strong>Support for <a href="#concurrency">concurrency</a></strong> (using <a href="https://github.com/mceachen/with_advisory_lock">with_advisory_lock</a>)</li>
<li><strong>Support for ActiveRecord 4.1, 4.2 and 5.0</strong></li>
<li><strong>Support for Ruby 2.0, 2.1, 2.2, 2.3.1 and JRuby 9000</strong></li>
<li>Support for reparenting children (and all their descendants)</li>
<li>Support for <a href="#sti">single-table inheritance (STI)</a> within the hierarchy</li>
<li>
<code>find_or_create_by_path</code> for <a href="#find_or_create_by_path">building out heterogeneous hierarchies quickly and conveniently</a>
</li>
<li>Support for <a href="#deterministic-ordering">deterministic ordering</a>
</li>
<li>Support for <a href="http://en.wikipedia.org/wiki/Tree_traversal#Pre-order">preordered</a> traversal of descendants</li>
<li>Support for rendering trees in <a href="http://en.wikipedia.org/wiki/DOT_(graph_description_language)">DOT format</a>, using <a href="http://www.graphviz.org/">Graphviz</a>
</li>
<li>Excellent <a href="#testing">test coverage</a> in a comprehensive variety of environments</li>
</ul>

<p>See <a href="http://karwin.blogspot.com/">Bill Karwin</a>'s excellent
<a href="http://www.slideshare.net/billkarwin/models-for-hierarchical-data">Models for hierarchical data presentation</a>
for a description of different tree storage algorithms.</p>

<h2>
<a id="table-of-contents" class="anchor" href="#table-of-contents" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Table of Contents</h2>

<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#warning">Warning</a></li>
<li><a href="#usage">Usage</a></li>
<li><a href="#accessing-data">Accessing Data</a></li>
<li><a href="#polymorphic-hierarchies-with-sti">Polymorphic hierarchies with STI</a></li>
<li><a href="#deterministic-ordering">Deterministic ordering</a></li>
<li><a href="#concurrency">Concurrency</a></li>
<li><a href="#faq">FAQ</a></li>
<li><a href="#testing">Testing</a></li>
<li><a href="#change-log">Change log</a></li>
</ul>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h2>

<p>Note that closure_tree only supports ActiveRecord 4.1 and later, and has test coverage for MySQL, PostgreSQL, and SQLite.</p>

<ol>
<li><p>Add <code>gem 'closure_tree'</code> to your Gemfile </p></li>
<li><p>Run <code>bundle install</code></p></li>
<li>
<p>Add <code>has_closure_tree</code> (or <code>acts_as_tree</code>, which is an alias of the same method) to your hierarchical model:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">Tag<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  has_closure_tree
<span class="pl-k">end</span>

<span class="pl-k">class</span> <span class="pl-en">AnotherTag<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  acts_as_tree
<span class="pl-k">end</span></pre></div>

<p>Make sure you check out the <a href="#available-options">large number options</a> that <code>has_closure_tree</code> accepts.</p>

<p><strong>IMPORTANT: Make sure you add <code>has_closure_tree</code> <em>after</em> <code>attr_accessible</code> and
<code>self.table_name =</code> lines in your model.</strong></p>

<p>If you're already using other hierarchical gems, like <code>ancestry</code> or <code>acts_as_tree</code>, please refer
to the <a href="#warning">warning section</a>!</p>
</li>
<li>
<p>Add a migration to add a <code>parent_id</code> column to the hierarchical model.
You may want to also <a href="#deterministic-ordering">add a column for deterministic ordering of children</a>, but that's optional.</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">AddParentIdToTag<span class="pl-e"> &lt; ActiveRecord::Migration</span></span>
  <span class="pl-k">def</span> <span class="pl-en">change</span>
    add_column <span class="pl-c1">:tag</span>, <span class="pl-c1">:parent_id</span>, <span class="pl-c1">:integer</span>
  <span class="pl-k">end</span>
<span class="pl-k">end</span></pre></div>

<p>The column must be nullable. Root nodes have a <code>NULL</code> <code>parent_id</code>.</p>
</li>
<li>
<p>Run <code>rails g closure_tree:migration tag</code> (and replace <code>tag</code> with your model name)
to create the closure tree table for your model.</p>

<p>By default the table name will be the model's table name, followed by
"_hierarchies". Note that by calling <code>has_closure_tree</code>, a "virtual model" (in this case, <code>TagHierarchy</code>)
will be created dynamically. You don't need to create it.</p>
</li>
<li><p>Run <code>rake db:migrate</code></p></li>
<li>
<p>If you're migrating from another system where your model already has a
<code>parent_id</code> column, run <code>Tag.rebuild!</code> and your
<code>tag_hierarchies</code> table will be truncated and rebuilt.</p>

<p>If you're starting from scratch you don't need to call <code>rebuild!</code>.</p>
</li>
</ol>

<p>NOTE: Run <code>rails g closure_tree:config</code> to create an initializer with extra
      configurations. (Optional)</p>

<h2>
<a id="warning" class="anchor" href="#warning" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Warning</h2>

<p>As stated above, using multiple hierarchy gems (like <code>ancestry</code> or <code>nested set</code>) on the same model 
will most likely result in pain, suffering, hair loss, tooth decay, heel-related ailments, and gingivitis.
Assume things will break. </p>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Usage</h2>

<h3>
<a id="creation" class="anchor" href="#creation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Creation</h3>

<p>Create a root node:</p>

<div class="highlight highlight-source-ruby"><pre>grandparent <span class="pl-k">=</span> <span class="pl-c1">Tag</span>.create(<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>Grandparent<span class="pl-pds">'</span></span>)</pre></div>

<p>Child nodes are created by appending to the children collection:</p>

<div class="highlight highlight-source-ruby"><pre>parent <span class="pl-k">=</span> grandparent.children.create(<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>Parent<span class="pl-pds">'</span></span>)</pre></div>

<p>Or by appending to the children collection:</p>

<div class="highlight highlight-source-ruby"><pre>child2 <span class="pl-k">=</span> <span class="pl-c1">Tag</span>.<span class="pl-k">new</span>(<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>Second Child<span class="pl-pds">'</span></span>)
parent.children <span class="pl-k">&lt;&lt;</span> child2</pre></div>

<p>Or by calling the "add_child" method:</p>

<div class="highlight highlight-source-ruby"><pre>child3 <span class="pl-k">=</span> <span class="pl-c1">Tag</span>.<span class="pl-k">new</span>(<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>Third Child<span class="pl-pds">'</span></span>)
parent.add_child child3</pre></div>

<p>Or by setting the parent on the child :</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">Tag</span>.create(<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>Fourth Child<span class="pl-pds">'</span></span>, <span class="pl-c1">parent:</span> parent)</pre></div>

<p>Then:</p>

<div class="highlight highlight-source-ruby"><pre>grandparent.self_and_descendants.collect(<span class="pl-k">&amp;</span><span class="pl-c1">:name</span>)
=&gt; [<span class="pl-s"><span class="pl-pds">"</span>Grandparent<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Parent<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>First Child<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Second Child<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Third Child<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Fourth Child<span class="pl-pds">"</span></span>]

child1.ancestry_path
=&gt; [<span class="pl-s"><span class="pl-pds">"</span>Grandparent<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>Parent<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>First Child<span class="pl-pds">"</span></span>]</pre></div>

<h3>
<a id="find_or_create_by_path" class="anchor" href="#find_or_create_by_path" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>find_or_create_by_path</h3>

<p>You can <code>find</code> as well as <code>find_or_create</code> by "ancestry paths".</p>

<p>If you provide an array of strings to these methods, they reference the <code>name</code> column in your 
model, which can be overridden with the <code>:name_column</code> option provided to <code>has_closure_tree</code>.</p>

<div class="highlight highlight-source-ruby"><pre>child <span class="pl-k">=</span> <span class="pl-c1">Tag</span>.find_or_create_by_path(<span class="pl-s"><span class="pl-pds">%w[</span>grandparent parent child<span class="pl-pds">]</span></span>)</pre></div>

<p>As of v5.0.0, <code>find_or_create_by_path</code> can also take an array of attribute hashes:</p>

<div class="highlight highlight-source-ruby"><pre>child <span class="pl-k">=</span> <span class="pl-c1">Tag</span>.find_or_create_by_path([
  {<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>Grandparent<span class="pl-pds">'</span></span>, <span class="pl-c1">title:</span> <span class="pl-s"><span class="pl-pds">'</span>Sr.<span class="pl-pds">'</span></span>},
  {<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>Parent<span class="pl-pds">'</span></span>, <span class="pl-c1">title:</span> <span class="pl-s"><span class="pl-pds">'</span>Mrs.<span class="pl-pds">'</span></span>},
  {<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>Child<span class="pl-pds">'</span></span>, <span class="pl-c1">title:</span> <span class="pl-s"><span class="pl-pds">'</span>Jr.<span class="pl-pds">'</span></span>}
])</pre></div>

<p>If you're using STI, The attribute hashes can contain the <code>sti_name</code> and things work as expected:</p>

<div class="highlight highlight-source-ruby"><pre>child <span class="pl-k">=</span> <span class="pl-c1">Label</span>.find_or_create_by_path([
  {<span class="pl-c1">type:</span> <span class="pl-s"><span class="pl-pds">'</span>DateLabel<span class="pl-pds">'</span></span>, <span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>2014<span class="pl-pds">'</span></span>},
  {<span class="pl-c1">type:</span> <span class="pl-s"><span class="pl-pds">'</span>DateLabel<span class="pl-pds">'</span></span>, <span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>August<span class="pl-pds">'</span></span>},
  {<span class="pl-c1">type:</span> <span class="pl-s"><span class="pl-pds">'</span>DateLabel<span class="pl-pds">'</span></span>, <span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>5<span class="pl-pds">'</span></span>},
  {<span class="pl-c1">type:</span> <span class="pl-s"><span class="pl-pds">'</span>EventLabel<span class="pl-pds">'</span></span>, <span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>Visit the Getty Center<span class="pl-pds">'</span></span>}
])</pre></div>

<h3>
<a id="moving-nodes-around-the-tree" class="anchor" href="#moving-nodes-around-the-tree" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Moving nodes around the tree</h3>

<p>Nodes can be moved around to other parents, and closure_tree moves the node's descendancy to the
new parent for you:</p>

<div class="highlight highlight-source-ruby"><pre>d <span class="pl-k">=</span> <span class="pl-c1">Tag</span>.find_or_create_by_path <span class="pl-s"><span class="pl-pds">%w[</span>a b c d<span class="pl-pds">]</span></span>
h <span class="pl-k">=</span> <span class="pl-c1">Tag</span>.find_or_create_by_path <span class="pl-s"><span class="pl-pds">%w[</span>e f g h<span class="pl-pds">]</span></span>
e <span class="pl-k">=</span> h.root
d.add_child(e) <span class="pl-c"># "d.children &lt;&lt; e" would work too, of course</span>
h.ancestry_path
=&gt; [<span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>c<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>d<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>e<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>f<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>g<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>h<span class="pl-pds">"</span></span>]</pre></div>

<p>When it is more convenient to simply change the <code>parent_id</code> of a node directly (for example, when dealing with a form <code>&lt;select&gt;</code>), closure_tree will handle the necessary changes automatically when the record is saved:</p>

<div class="highlight highlight-source-ruby"><pre>j <span class="pl-k">=</span> <span class="pl-c1">Tag</span>.find <span class="pl-c1">102</span>
j.self_and_ancestor_ids
=&gt; [<span class="pl-c1">102</span>, <span class="pl-c1">87</span>, <span class="pl-c1">77</span>]
j.update <span class="pl-c1">parent_id:</span> <span class="pl-c1">96</span>
j.self_and_ancestor_ids
=&gt; [<span class="pl-c1">102</span>, <span class="pl-c1">96</span>, <span class="pl-c1">95</span>, <span class="pl-c1">78</span>]</pre></div>

<h3>
<a id="nested-hashes" class="anchor" href="#nested-hashes" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Nested hashes</h3>

<p><code>hash_tree</code> provides a method for rendering a subtree as an
ordered nested hash:</p>

<div class="highlight highlight-source-ruby"><pre>b <span class="pl-k">=</span> <span class="pl-c1">Tag</span>.find_or_create_by_path <span class="pl-s"><span class="pl-pds">%w(</span>a b<span class="pl-pds">)</span></span>
a <span class="pl-k">=</span> b.parent
b2 <span class="pl-k">=</span> <span class="pl-c1">Tag</span>.find_or_create_by_path <span class="pl-s"><span class="pl-pds">%w(</span>a b2<span class="pl-pds">)</span></span>
d1 <span class="pl-k">=</span> b.find_or_create_by_path <span class="pl-s"><span class="pl-pds">%w(</span>c1 d1<span class="pl-pds">)</span></span>
c1 <span class="pl-k">=</span> d1.parent
d2 <span class="pl-k">=</span> b.find_or_create_by_path <span class="pl-s"><span class="pl-pds">%w(</span>c2 d2<span class="pl-pds">)</span></span>
c2 <span class="pl-k">=</span> d2.parent

<span class="pl-c1">Tag</span>.hash_tree
=&gt; {a =&gt; {b =&gt; {c1 =&gt; {d1 =&gt; {}}, c2 =&gt; {d2 =&gt; {}}}, b2 =&gt; {}}}

<span class="pl-c1">Tag</span>.hash_tree(<span class="pl-c1">:limit_depth</span> =&gt; <span class="pl-c1">2</span>)
=&gt; {a =&gt; {b =&gt; {}, b2 =&gt; {}}}

b.hash_tree
=&gt; {b =&gt; {c1 =&gt; {d1 =&gt; {}}, c2 =&gt; {d2 =&gt; {}}}}

b.hash_tree(<span class="pl-c1">:limit_depth</span> =&gt; <span class="pl-c1">2</span>)
=&gt; {b =&gt; {c1 =&gt; {}, c2 =&gt; {}}}</pre></div>

<p><strong>If your tree is large (or might become so), use :limit_depth.</strong></p>

<p>Without this option, <code>hash_tree</code> will load the entire contents of that table into RAM. Your
server may not be happy trying to do this.</p>

<p>HT: <a href="https://github.com/stefankroes/ancestry#arrangement">ancestry</a> and <a href="https://github.com/mceachen/closure_tree/issues/11">elhoyos</a></p>

<h3>
<a id="graph-visualization" class="anchor" href="#graph-visualization" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Graph visualization</h3>

<p><code>to_dot_digraph</code> is suitable for passing into <a href="http://www.graphviz.org/">Graphviz</a>.</p>

<p>For example, for the above tree, write out the DOT file with ruby:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-c1">File</span>.open(<span class="pl-s"><span class="pl-pds">"</span>example.dot<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>w<span class="pl-pds">"</span></span>) { |<span class="pl-smi">f</span>| f.write(<span class="pl-c1">Tag</span>.root.to_dot_digraph) }</pre></div>

<p>Then, in a shell, <code>dot -Tpng example.dot &gt; example.png</code>, which produces:</p>

<p><img src="https://raw.github.com/mceachen/closure_tree/master/img/example.png" alt="Example tree"></p>

<p>If you want to customize the label value, override the <code>#to_digraph_label</code> instance method in your model.</p>

<p>Just for kicks, this is the test tree I used for proving that preordered tree traversal was correct:</p>

<p><img src="https://raw.github.com/mceachen/closure_tree/master/img/preorder.png" alt="Preordered test tree"></p>

<h3>
<a id="available-options" class="anchor" href="#available-options" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Available options</h3>

<p>When you include <code>has_closure_tree</code> in your model, you can provide a hash to override the following defaults:</p>

<ul>
<li>
<code>:parent_column_name</code> to override the column name of the parent foreign key in the model's table. This defaults to "parent_id".</li>
<li>
<code>:hierarchy_class_name</code> to override the hierarchy class name. This defaults to the singular name of the model + "Hierarchy", like <code>TagHierarchy</code>.</li>
<li>
<code>:hierarchy_table_name</code> to override the hierarchy table name. This defaults to the singular name of the model + "_hierarchies", like <code>tag_hierarchies</code>.</li>
<li>
<code>:dependent</code> determines what happens when a node is destroyed. Defaults to <code>nullify</code>.

<ul>
<li>
<code>:nullify</code> will simply set the parent column to null. Each child node will be considered a "root" node. This is the default.</li>
<li>
<code>:delete_all</code> will delete all descendant nodes (which circumvents the destroy hooks)</li>
<li>
<code>:destroy</code> will destroy all descendant nodes (which runs the destroy hooks on each child node)</li>
<li>
<code>nil</code> does nothing with descendant nodes</li>
</ul>
</li>
<li>
<code>:name_column</code> used by #<code>find_or_create_by_path</code>, #<code>find_by_path</code>, and <code>ancestry_path</code> instance methods. This is primarily useful if the model only has one required field (like a "tag").</li>
<li>
<code>:order</code> used to set up <a href="#deterministic-ordering">deterministic ordering</a>
</li>
<li>
<code>:touch</code> delegates to the <code>belongs_to</code> annotation for the parent, so <code>touch</code>ing cascades to all children (the performance of this for deep trees isn't currently optimal).</li>
</ul>

<h2>
<a id="accessing-data" class="anchor" href="#accessing-data" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Accessing Data</h2>

<h3>
<a id="class-methods" class="anchor" href="#class-methods" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Class methods</h3>

<ul>
<li>
<code>Tag.root</code> returns an arbitrary root node</li>
<li>
<code>Tag.roots</code> returns all root nodes</li>
<li>
<code>Tag.leaves</code> returns all leaf nodes</li>
<li>
<code>Tag.hash_tree</code> returns an <a href="#nested-hashes">ordered, nested hash</a> that can be depth-limited.</li>
<li>
<code>Tag.find_by_path(path, attributes)</code> returns the node whose name path is <code>path</code>. See (#find_or_create_by_path).</li>
<li>
<code>Tag.find_or_create_by_path(path, attributes)</code> returns the node whose name path is <code>path</code>, and will create the node if it doesn't exist already.See (#find_or_create_by_path).</li>
<li>
<code>Tag.find_all_by_generation(generation_level)</code> returns the descendant nodes who are <code>generation_level</code> away from a root. <code>Tag.find_all_by_generation(0)</code> is equivalent to <code>Tag.roots</code>.</li>
<li>
<code>Tag.with_ancestor(ancestors)</code> scopes to all descendants whose ancestor is in the given list.</li>
</ul>

<h3>
<a id="instance-methods" class="anchor" href="#instance-methods" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Instance methods</h3>

<ul>
<li>
<code>tag.root</code> returns the root for this node</li>
<li>
<code>tag.root?</code> returns true if this is a root node</li>
<li>
<code>tag.child?</code> returns true if this is a child node. It has a parent.</li>
<li>
<code>tag.leaf?</code> returns true if this is a leaf node. It has no children.</li>
<li>
<code>tag.leaves</code> is scoped to all leaf nodes in self_and_descendants.</li>
<li>
<code>tag.depth</code> returns the depth, or "generation", for this node in the tree. A root node will have a value of 0.</li>
<li>
<code>tag.parent</code> returns the node's immediate parent. Root nodes will return nil.</li>
<li>
<code>tag.children</code> is a <code>has_many</code> of immediate children (just those nodes whose parent is the current node).</li>
<li>
<code>tag.child_ids</code> is an array of the IDs of the children.</li>
<li>
<code>tag.ancestors</code> is a ordered scope of [ parent, grandparent, great grandparent, â€¦ ]. Note that the size of this array will always equal <code>tag.depth</code>.</li>
<li>
<code>tag.ancestor_ids</code> is an array of the IDs of the ancestors.</li>
<li>
<code>tag.self_and_ancestors</code> returns a scope containing self, parent, grandparent, great grandparent, etc.</li>
<li>
<code>tag.self_and_ancestors_ids</code> returns IDs containing self, parent, grandparent, great grandparent, etc.</li>
<li>
<code>tag.siblings</code> returns a scope containing all nodes with the same parent as <code>tag</code>, excluding self.</li>
<li>
<code>tag.sibling_ids</code> returns an array of the IDs of the siblings.</li>
<li>
<code>tag.self_and_siblings</code> returns a scope containing all nodes with the same parent as <code>tag</code>, including self.</li>
<li>
<code>tag.descendants</code> returns a scope of all children, childrens' children, etc., excluding self ordered by depth.</li>
<li>
<code>tag.descendant_ids</code> returns an array of the IDs of the descendants.</li>
<li>
<code>tag.self_and_descendants</code> returns a scope of self, all children, childrens' children, etc., ordered by depth.</li>
<li>
<code>tag.self_and_descendant_ids</code> returns IDs of self, all children, childrens' children, etc., ordered by depth.</li>
<li>
<code>tag.hash_tree</code> returns an <a href="#nested-hashes">ordered, nested hash</a> that can be depth-limited.</li>
<li>
<code>tag.find_by_path(path)</code> returns the node whose name path <em>from <code>tag</code></em> is <code>path</code>. See (#find_or_create_by_path).</li>
<li>
<code>tag.find_or_create_by_path(path)</code> returns the node whose name path <em>from <code>tag</code></em> is <code>path</code>, and will create the node if it doesn't exist already.See (#find_or_create_by_path).</li>
<li>
<code>tag.find_all_by_generation(generation_level)</code> returns the descendant nodes who are <code>generation_level</code> away from <code>tag</code>.

<ul>
<li>
<code>tag.find_all_by_generation(0).to_a</code> == <code>[tag]</code>
</li>
<li>
<code>tag.find_all_by_generation(1)</code> == <code>tag.children</code>
</li>
<li>
<code>tag.find_all_by_generation(2)</code> will return the tag's grandchildren, and so on.</li>
</ul>
</li>
<li>
<code>tag.destroy</code> will destroy a node and do <em>something</em> to its children, which is determined by the <code>:dependent</code> option passed to <code>has_closure_tree</code>.</li>
</ul>

<h2>
<a id="polymorphic-hierarchies-with-sti" class="anchor" href="#polymorphic-hierarchies-with-sti" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Polymorphic hierarchies with STI</h2>

<p>Polymorphic models using single table inheritance (STI) are supported:</p>

<ol>
<li>Create a db migration that adds a String <code>type</code> column to your model</li>
<li>Subclass the model class. You only need to add <code>has_closure_tree</code> to your base class:</li>
</ol>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">Tag<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  has_closure_tree
<span class="pl-k">end</span>
<span class="pl-k">class</span> <span class="pl-en">WhenTag<span class="pl-e"> &lt; Tag</span></span> ; <span class="pl-k">end</span>
<span class="pl-k">class</span> <span class="pl-en">WhereTag<span class="pl-e"> &lt; Tag</span></span> ; <span class="pl-k">end</span>
<span class="pl-k">class</span> <span class="pl-en">WhatTag<span class="pl-e"> &lt; Tag</span></span> ; <span class="pl-k">end</span></pre></div>

<h2>
<a id="deterministic-ordering" class="anchor" href="#deterministic-ordering" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Deterministic ordering</h2>

<p>By default, children will be ordered by your database engine, which may not be what you want.</p>

<p>If you want to order children alphabetically, and your model has a <code>name</code> column, you'd do this:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">Tag<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  has_closure_tree <span class="pl-c1">order:</span> <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>
<span class="pl-k">end</span></pre></div>

<p>If you want a specific order, add a new integer column to your model in a migration:</p>

<div class="highlight highlight-source-ruby"><pre>t.integer <span class="pl-c1">:sort_order</span></pre></div>

<p>and in your model:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">OrderedTag<span class="pl-e"> &lt; ActiveRecord::Base</span></span>
  has_closure_tree <span class="pl-c1">order:</span> <span class="pl-s"><span class="pl-pds">'</span>sort_order<span class="pl-pds">'</span></span>
<span class="pl-k">end</span></pre></div>

<p>When you enable <code>order</code>, you'll also have the following new methods injected into your model:</p>

<ul>
<li>
<code>tag.siblings_before</code> is a scope containing all nodes with the same parent as <code>tag</code>,
whose sort order column is less than <code>self</code>. These will be ordered properly, so the <code>last</code>
element in scope will be the sibling immediately before <code>self</code>
</li>
<li>
<code>tag.siblings_after</code> is a scope containing all nodes with the same parent as <code>tag</code>,
whose sort order column is more than <code>self</code>. These will be ordered properly, so the <code>first</code>
element in scope will be the sibling immediately "after" <code>self</code>
</li>
</ul>

<p>If your <code>order</code> column is an integer attribute, you'll also have these:</p>

<ul>
<li><p>The class method <code>#roots_and_descendants_preordered</code>, which returns all nodes in your tree,
<a href="http://en.wikipedia.org/wiki/Tree_traversal#Pre-order">pre-ordered</a>.</p></li>
<li><p><code>node1.self_and_descendants_preordered</code> which will return descendants,
<a href="http://en.wikipedia.org/wiki/Tree_traversal#Pre-order">pre-ordered</a>.</p></li>
<li>
<p><code>node1.append_child(node2)</code> (which is an alias to <code>add_child</code>), which will</p>

<ol>
<li>set <code>node2</code>'s parent to <code>node1</code>
</li>
<li>set <code>node2</code>'s sort order to place node2 last in the <code>children</code> array</li>
</ol>
</li>
<li>
<p><code>node1.prepend_child(node2)</code> which will</p>

<ol>
<li>set <code>node2</code>'s parent to <code>node1</code>
</li>
<li>set <code>node2</code>'s sort order to place node2 first in the <code>children</code> array
Note that all of <code>node1</code>'s children's sort_orders will be incremented</li>
</ol>
</li>
<li>
<p><code>node1.prepend_sibling(node2)</code> which will</p>

<ol>
<li>set <code>node2</code> to the same parent as <code>node1</code>,</li>
<li>set <code>node2</code>'s order column to 1 less than <code>node1</code>'s value, and</li>
<li>increment the order_column of all children of node1's parents whose order_column is &gt; node2's new value by 1.</li>
</ol>
</li>
<li>
<p><code>node1.append_sibling(node2)</code> which will</p>

<ol>
<li>set <code>node2</code> to the same parent as <code>node1</code>,</li>
<li>set <code>node2</code>'s order column to 1 more than <code>node1</code>'s value, and</li>
<li>increment the order_column of all children of node1's parents whose order_column is &gt; node2's new value by 1.</li>
</ol>
</li>
</ul>

<div class="highlight highlight-source-ruby"><pre>
root <span class="pl-k">=</span> <span class="pl-c1">OrderedTag</span>.create(<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>root<span class="pl-pds">'</span></span>)
a <span class="pl-k">=</span> root.append_child(<span class="pl-c1">Label</span>.<span class="pl-k">new</span>(<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>))
b <span class="pl-k">=</span> <span class="pl-c1">OrderedTag</span>.create(<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>b<span class="pl-pds">'</span></span>)
c <span class="pl-k">=</span> <span class="pl-c1">OrderedTag</span>.create(<span class="pl-c1">name:</span> <span class="pl-s"><span class="pl-pds">'</span>c<span class="pl-pds">'</span></span>)

<span class="pl-c"># We have to call 'root.reload.children' because root won't be in sync with the database otherwise:</span>

a.append_sibling(b)
root.reload.children.pluck(<span class="pl-c1">:name</span>)
=&gt; [<span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span>]

a.prepend_sibling(b)
root.reload.children.pluck(<span class="pl-c1">:name</span>)
=&gt; [<span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span>]

a.append_sibling(c)
root.reload.children.pluck(<span class="pl-c1">:name</span>)
=&gt; [<span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>c<span class="pl-pds">"</span></span>]

b.append_sibling(c)
root.reload.children.pluck(<span class="pl-c1">:name</span>)
=&gt; [<span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>c<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span>]</pre></div>

<h2>
<a id="concurrency" class="anchor" href="#concurrency" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Concurrency</h2>

<p>Several methods, especially <code>#rebuild</code> and <code>#find_or_create_by_path</code>, cannot run concurrently correctly.
<code>#find_or_create_by_path</code>, for example, may create duplicate nodes.</p>

<p>Database row-level locks work correctly with PostgreSQL, but MySQL's row-level locking is broken, and
erroneously reports deadlocks where there are none. To work around this, and have a consistent implementation
for both MySQL and PostgreSQL, <a href="https://github.com/mceachen/with_advisory_lock">with_advisory_lock</a>
is used automatically to ensure correctness.</p>

<p>If you are already managing concurrency elsewhere in your application, and want to disable the use
of with_advisory_lock, pass <code>with_advisory_lock: false</code> in the options hash:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">class</span> <span class="pl-en">Tag</span>
  has_closure_tree <span class="pl-c1">with_advisory_lock:</span> <span class="pl-c1">false</span>
<span class="pl-k">end</span></pre></div>

<p>Note that you <em>will eventually have data corruption</em> if you disable advisory locks, write to your
database with multiple threads, and don't provide an alternative mutex.</p>

<h2>
<a id="faq" class="anchor" href="#faq" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>FAQ</h2>

<h3>
<a id="are-there-any-how-to-articles-on-how-to-use-this-gem" class="anchor" href="#are-there-any-how-to-articles-on-how-to-use-this-gem" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Are there any how-to articles on how to use this gem?</h3>

<p>Yup! <a href="https://github.com/bodrovis">Ilya Bodrov</a> wrote <a href="http://www.sitepoint.com/nested-comments-rails/">Nested Comments with Rails</a>.</p>

<h3>
<a id="does-this-work-well-with-default_scope" class="anchor" href="#does-this-work-well-with-default_scope" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Does this work well with <code>#default_scope</code>?</h3>

<p><strong>No.</strong> Please see <a href="https://github.com/mceachen/closure_tree/issues/86">issue 86</a> for details.</p>

<h3>
<a id="can-i-update-parentage-with-update_attribute" class="anchor" href="#can-i-update-parentage-with-update_attribute" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Can I update parentage with <code>update_attribute</code>?</h3>

<p><strong>No.</strong> <code>update_attribute</code> skips the validation hook that is required for maintaining the 
hierarchy table.</p>

<h3>
<a id="does-this-gem-support-multiple-parents" class="anchor" href="#does-this-gem-support-multiple-parents" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Does this gem support multiple parents?</h3>

<p>No. This gem's API is based on the assumption that each node has either 0 or 1 parent.</p>

<p>The underlying closure tree structure will support multiple parents, but there would be many
breaking-API changes to support it. I'm open to suggestions and pull requests.</p>

<h3>
<a id="how-do-i-use-this-with-test-fixtures" class="anchor" href="#how-do-i-use-this-with-test-fixtures" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>How do I use this with test fixtures?</h3>

<p>Test fixtures aren't going to be running your <code>after_save</code> hooks after inserting all your
fixture data, so you need to call <code>.rebuild!</code> before your test runs. There's an example in
the spec <code>tag_spec.rb</code>:</p>

<div class="highlight highlight-source-ruby"><pre>  describe <span class="pl-s"><span class="pl-pds">"</span>Tag with fixtures<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
    fixtures <span class="pl-c1">:tags</span>
    before <span class="pl-c1">:each</span> <span class="pl-k">do</span>
      <span class="pl-c1">Tag</span>.rebuild! <span class="pl-c"># &lt;- required if you use fixtures</span>
    <span class="pl-k">end</span></pre></div>

<p><strong>However, if you're just starting with Rails, may I humbly suggest you adopt a factory library</strong>,
rather than using fixtures? <a href="https://www.google.com/search?q=fixtures+versus+factories">Lots of people have written about this already</a>.</p>

<h3>
<a id="there-are-many-lock--files-in-my-project-directory-after-test-runs" class="anchor" href="#there-are-many-lock--files-in-my-project-directory-after-test-runs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>There are many <code>lock-*</code> files in my project directory after test runs</h3>

<p>This is expected if you aren't using MySQL or Postgresql for your tests.</p>

<p>SQLite doesn't have advisory locks, so we resort to file locking, which will only work
if the <code>FLOCK_DIR</code> is set consistently for all ruby processes.</p>

<p>In your <code>spec_helper.rb</code> or <code>minitest_helper.rb</code>, add a <code>before</code> and <code>after</code> block:</p>

<div class="highlight highlight-source-ruby"><pre>before <span class="pl-k">do</span>
  <span class="pl-c1">ENV</span>[<span class="pl-s"><span class="pl-pds">'</span>FLOCK_DIR<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> <span class="pl-c1">Dir</span>.mktmpdir
<span class="pl-k">end</span>

after <span class="pl-k">do</span>
  <span class="pl-c1">FileUtils</span>.remove_entry_secure <span class="pl-c1">ENV</span>[<span class="pl-s"><span class="pl-pds">'</span>FLOCK_DIR<span class="pl-pds">'</span></span>]
<span class="pl-k">end</span></pre></div>

<h3>
<a id="bundle-install-says-gemextbuilderror-error-failed-to-build-gem-native-extension" class="anchor" href="#bundle-install-says-gemextbuilderror-error-failed-to-build-gem-native-extension" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a><code>bundle install</code> says <code>Gem::Ext::BuildError: ERROR: Failed to build gem native extension</code>
</h3>

<p>When building from source, the <code>mysql2</code>, <code>pg</code>, and <code>sqlite</code> gems need their native client libraries
installed on your system. Note that this error isn't specific to ClosureTree.</p>

<p>On Ubuntu/Debian systems, run:</p>

<pre><code>sudo apt-get install libpq-dev libsqlite3-dev libmysqlclient-dev
bundle install
</code></pre>

<h3>
<a id="object-destroy-fails-with-mysql-57" class="anchor" href="#object-destroy-fails-with-mysql-57" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Object destroy fails with MySQL 5.7+</h3>

<p>A bug was introduced in MySQL's query optimizer. <a href="https://github.com/mceachen/closure_tree/issues/206">See the workaround here</a>.</p>

<h2>
<a id="testing-with-closure-tree" class="anchor" href="#testing-with-closure-tree" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Testing with Closure Tree</h2>

<p>Closure tree comes with some RSpec2/3 matchers which you may use for your tests:</p>

<div class="highlight highlight-source-ruby"><pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">'</span>spec_helper<span class="pl-pds">'</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">'</span>closure_tree/test/matcher<span class="pl-pds">'</span></span>

describe <span class="pl-c1">Category</span> <span class="pl-k">do</span>
 <span class="pl-c"># Should syntax</span>
 it { should be_a_closure_tree }
 <span class="pl-c"># Expect syntax</span>
 it { is_expected.to be_a_closure_tree }
<span class="pl-k">end</span>

describe <span class="pl-c1">Label</span> <span class="pl-k">do</span>
 <span class="pl-c"># Should syntax</span>
 it { should be_a_closure_tree.ordered }
 <span class="pl-c"># Expect syntax</span>
 it { is_expected.to be_a_closure_tree.ordered }
<span class="pl-k">end</span>

describe <span class="pl-c1">TodoList</span>::<span class="pl-c1">Item</span> <span class="pl-k">do</span>
 <span class="pl-c"># Should syntax</span>
 it { should be_a_closure_tree.ordered(<span class="pl-c1">:priority_order</span>) }
 <span class="pl-c"># Expect syntax</span>
 it { is_expected.to be_a_closure_tree.ordered(<span class="pl-c1">:priority_order</span>) }
<span class="pl-k">end</span>
</pre></div>

<h2>
<a id="testing" class="anchor" href="#testing" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Testing</h2>

<p>Closure tree is <a href="http://travis-ci.org/#!/mceachen/closure_tree">tested under every valid combination</a> of</p>

<ul>
<li>Ruby 2.0, 2.2, 2.3.1</li>
<li>ActiveRecord 4.1, 4.2, and 5.0</li>
<li>PostgreSQL, MySQL, and SQLite. Concurrency tests are only run with MySQL and PostgreSQL.</li>
</ul>

<p>Assuming you're using <a href="https://github.com/sstephenson/rbenv">rbenv</a>, you can use <code>tests.sh</code> to
run the test matrix locally.</p>

<h2>
<a id="change-log" class="anchor" href="#change-log" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Change log</h2>

<p>See the <a href="https://github.com/mceachen/closure_tree/blob/master/CHANGELOG.md">change log</a>.</p>

<h2>
<a id="thanks-to" class="anchor" href="#thanks-to" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Thanks to</h2>

<ul>
<li>The 45+ engineers around the world that have contributed their time and code to this gem
(see the <a href="https://github.com/mceachen/closure_tree/blob/master/CHANGELOG.md">changelog</a>!)</li>
<li><a href="https://github.com/collectiveidea/awesome_nested_set">https://github.com/collectiveidea/awesome_nested_set</a></li>
<li><a href="https://github.com/patshaughnessy/class_factory">https://github.com/patshaughnessy/class_factory</a></li>
<li>JetBrains, which provides an <a href="http://www.jetbrains.com/ruby/buy/buy.jsp#openSource">open-source license</a> to
<a href="http://www.jetbrains.com/ruby/features/">RubyMine</a> for the development of this project.</li>
</ul>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/mceachen">mceachen</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-38750440-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
